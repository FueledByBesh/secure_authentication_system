<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title th:text="${title}">User Settings</title>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', 'Noto Sans', sans-serif; margin: 0; }
    .container { max-width: 820px; margin: 32px auto; padding: 24px; }
    h1 { font-size: 1.6rem; margin: 0 0 16px; }
    .card { border: 1px solid #9993; border-radius: 12px; padding: 20px; }
    .row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    button { padding: 10px 14px; border-radius: 8px; border: 1px solid #5556; background: #2d6cdf; color: white; font-weight: 600; cursor: pointer; }
    button.secondary { background: transparent; color: inherit; }
    img.qr { width: 256px; height: 256px; image-rendering: pixelated; border-radius: 8px; border: 1px solid #9994; display:none; }
    .status { margin-top: 10px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; padding: 8px 10px; border-radius: 8px; border: 1px solid #9995; }
    .ok { color: #05620a; border-color: #2bbf2f55; background: #2bbf2f0f; }
    .err { color: #7b1111; border-color: #ff616155; background: #ff61610f; }
    .muted { opacity: .7; }
    nav a { color: #2d6cdf; text-decoration: none; }
  </style>
  <script>
    async function call(endpoint, okMsg){
      const status = document.getElementById('status');
      status.className = 'status';
      status.textContent = 'Working…';
      try {
        const res = await fetch(endpoint);
        if (res.status === 403) {
          status.className = 'status err';
          status.textContent = 'Resource forbidden (invalid token). Please log in again.';
          return;
        }
        const data = await res.json().catch(()=>({message: res.statusText}));
        if(!res.ok) throw new Error(data.message || 'Request failed');
        status.className = 'status ok';
        status.textContent = okMsg || data.message || 'OK';
        await updateState();
      } catch(e){
        status.className = 'status err';
        status.textContent = e.message || 'Request failed';
      }
    }

    function showQr(){
      const img = document.getElementById('qr');
      img.src = '/totp/totp-qr?t=' + Date.now();
      img.style.display = 'block';
    }

    async function updateState(){
      try{
        const res = await fetch('/user/settings/me');
        const status = document.getElementById('status');
        const showBtn = document.getElementById('showqr');
        const enableBtn = document.getElementById('enable');
        const disableBtn = document.getElementById('disable');
        const img = document.getElementById('qr');

        if (res.status === 403) {
          // Explicitly handle forbidden/invalid token
          status.className = 'status err';
          status.textContent = 'Resource forbidden (invalid token). Please log in again.';
          // Lock down UI
          showBtn.disabled = true;
          enableBtn.disabled = true;
          disableBtn.disabled = true;
          img.removeAttribute('src');
          img.style.display = 'none';
          return;
        }
        if(!res.ok) {
          // Other errors
          status.className = 'status err';
          status.textContent = 'Failed to load settings.';
          return;
        }
        const data = await res.json();
        const enabled = !!data.is_2fa_enabled;

        // Button states
        showBtn.disabled = !enabled;
        enableBtn.disabled = enabled;
        disableBtn.disabled = !enabled;

        // Visual state: highlight the chosen/current option
        // If 2FA is enabled => Enable 2FA is primary (blue), Disable 2FA is secondary (transparent)
        // If 2FA is disabled => Disable 2FA is primary (blue), Enable 2FA is secondary (transparent)
        if (enabled) {
          // 2FA currently enabled → highlight Enable
          enableBtn.classList.remove('secondary');
          disableBtn.classList.add('secondary');
        } else {
          // 2FA currently disabled → highlight Disable
          enableBtn.classList.add('secondary');
          disableBtn.classList.remove('secondary');
        }

        // QR visibility per requirement: show only when 2FA enabled
        if(enabled){
          // Load/refresh QR automatically when enabled
          img.src = '/totp/totp-qr?t=' + Date.now();
          img.style.display = 'block';
        } else {
          img.removeAttribute('src');
          img.style.display = 'none';
        }
        // Reset status when loaded successfully
        status.className = 'status muted';
        status.textContent = 'Ready.';
      }catch(e){
        const status = document.getElementById('status');
        status.className = 'status err';
        status.textContent = 'Unexpected error while loading settings.';
      }
    }

    async function logoutNow(ev){
      ev?.preventDefault();
      const status = document.getElementById('status');
      status.className = 'status';
      status.textContent = 'Logging out…';
      try {
        // Use backend logout endpoint which also clears cookies
        await fetch('/auth/logout');
      } catch (e) {
        // ignore network errors and proceed to redirect
      } finally {
        // Redirect to login page regardless of response status
        window.location.href = '/app/auth';
      }
    }

    async function changePassword(ev){
      ev?.preventDefault();
      const oldPw = document.getElementById('oldpw').value;
      const newPw = document.getElementById('newpw').value;
      const out = document.getElementById('pw-status');
      out.className = 'status muted';
      out.textContent = 'Submitting…';
      try{
        const res = await fetch('/user/settings/change-password',{
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ oldPassword: oldPw, newPassword: newPw })
        });
        // Always try to read body as JSON to get message
        let data;
        try { data = await res.json(); } catch (_) { data = { message: res.statusText || 'No message' }; }
        const msg = data && data.message ? data.message : 'Done';
        if (res.status === 403) {
          out.className = 'status err';
          out.textContent = 'Resource forbidden (invalid token). Please log in again.';
          // Optionally disable form inputs
          document.getElementById('oldpw').disabled = true;
          document.getElementById('newpw').disabled = true;
          document.getElementById('pw-submit').disabled = true;
          return;
        }
        if (res.ok) {
          out.className = 'status ok';
          out.textContent = msg;
          // Clear fields on success
          document.getElementById('oldpw').value = '';
          document.getElementById('newpw').value = '';
        } else {
          out.className = 'status err';
          out.textContent = msg;
        }
      }catch(e){
        out.className = 'status err';
        out.textContent = 'Request failed';
      }
    }

    window.addEventListener('DOMContentLoaded', ()=>{
      document.getElementById('enable').addEventListener('click', ()=>call('/user/settings/enable-2fa','2FA enabled'));
      document.getElementById('disable').addEventListener('click', ()=>call('/user/settings/disable-2fa','2FA disabled'));
      document.getElementById('showqr').addEventListener('click', showQr);
      document.getElementById('logout').addEventListener('click', logoutNow);
      document.getElementById('pw-form').addEventListener('submit', changePassword);
      updateState();
    });
  </script>
  <link rel="icon" href="data:," />
</head>
<body>
  <div class="container">
    <nav style="margin-bottom:12px"><a href="#" id="logout">Log out</a></nav>
    <h1 th:text="${title}">User Settings</h1>
    <div class="card">
      <p class="muted">Manage your Two‑Factor Authentication (TOTP).</p>
      <div class="row" style="margin: 10px 0 16px;">
        <button id="enable">Enable 2FA</button>
        <button id="disable" class="secondary">Disable 2FA</button>
        <button id="showqr" class="secondary" style="display:none">Show QR code</button>
      </div>
      <img id="qr" class="qr" alt="TOTP QR" />
      <div id="status" class="status muted">Ready.</div>
    </div>

    <div class="card" style="margin-top:16px;">
      <p class="muted">Change password</p>
      <form id="pw-form" class="row" style="gap:10px; align-items: flex-end; flex-wrap: wrap;">
        <div style="min-width:240px;">
          <label for="oldpw">Old password</label>
          <input id="oldpw" name="oldpw" type="password" autocomplete="current-password" />
        </div>
        <div style="min-width:240px;">
          <label for="newpw">New password</label>
          <input id="newpw" name="newpw" type="password" autocomplete="new-password" />
        </div>
        <div>
          <button id="pw-submit" type="submit">Change password</button>
        </div>
        <div id="pw-status" class="status muted" style="flex:1 1 100%;">Awaiting input…</div>
      </form>
    </div>
  </div>
</body>
</html>
